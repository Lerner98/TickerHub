# TickerHub Changelog - v0.2.0 (Stock Market Expansion)

**Release Date:** 2025-12-08 (In Progress)
**Branch:** `main`
**Status:** Phase 1 Data Layer Complete

---

## Overview

Stock market expansion - Phase 1 of adding Finnhub API integration for US stock data. Establishes unified asset system enabling crypto + stocks in same platform.

---

## Features Implemented

### Unified Asset System (ADR-007)
- `BaseAsset` interface with shared fields across asset types
- `CryptoAsset` type extending base with crypto-specific fields
- `StockAsset` type extending base with stock-specific fields
- Discriminated union: `Asset = CryptoAsset | StockAsset`
- Type guards: `isCryptoAsset()`, `isStockAsset()`
- Location: `shared/schema.ts:120-247`

### Circuit Breaker Pattern (ADR-008)
- Full implementation based on unified doc Section 3
- States: CLOSED → OPEN → HALF_OPEN
- Pre-configured breakers for all external APIs
- `executeWithFallback()` for graceful degradation
- Location: `server/lib/circuitBreaker.ts`

### Stock Market Service
- Finnhub API integration (mock data in development ONLY)
- Cache-first pattern with stale fallback
- **Development:** Mock data (zero API calls)
- **Production:** Real API → Stale Cache (5min) → null (graceful failure)
- Functions: `fetchStockQuote`, `fetchStockProfile`, `getStockAsset`
- Location: `server/api/stocks/service.ts`

### Stock Market Routes
- `GET /api/stocks` - Top 10 stocks
- `GET /api/stocks/:symbol` - Single stock details
- `GET /api/stocks/search?q=` - Search stocks
- `GET /api/stocks/batch?symbols=` - Multiple stocks
- `GET /api/stocks/status` - Service health
- Location: `server/api/stocks/routes.ts`

### Mock Data System
- Zero API calls in development by default
- `shouldUseMock()` utility
- Mock Finnhub quotes and profiles for 10 major stocks
- Location: `server/mocks/`

---

## Architecture Decisions

### ADR-006: Polling + Aggressive Cache (Not WebSocket)
**Decision:** HTTP polling with 60s cache TTL for stocks
**Rationale:**
- WebSocket adds complexity (connection management, reconnection logic)
- 60s staleness acceptable for MVP (same as crypto)
- Can add WebSocket later without breaking existing code
- Follows YAGNI - build only what's needed now

### ADR-007: Unified Asset Type with Discriminator
**Decision:** Single `Asset` type with `type: 'crypto' | 'stock'` discriminator
**Rationale:**
- Enables unified search, watchlist, alerts from day 1
- Shared fields: `symbol`, `name`, `price`, `change24h`, `volume`
- Type-specific fields via discriminated union
- Follows Open/Closed principle - extend without modifying

### ADR-008: Circuit Breaker for External APIs
**Decision:** Implement Circuit Breaker pattern for all external API calls
**Rationale:**
- Prevents cascade failures
- Enables clean fallback chain: `Primary → Stale Cache → null`
- Production pattern from day 1
- Matches unified doc Section 3 (Reliability Engineering)

### ADR-009: Request Coalescing for Batch Lookups
**Decision:** Batch multiple symbol requests into single API call
**Rationale:**
- Finnhub supports multi-symbol queries
- Maximizes 60 calls/min budget
- Priority: user-requested > background refresh

### ADR-010: Fallback Chain Strategy (CORRECTED)
**Decision:** Production NEVER falls back to mock data
**Rationale:**
- Mock data is ONLY for development/testing - reduces API costs
- Production fallback chain: `Real API → Stale Cache (5min) → null`
- UI handles null gracefully (show "unavailable" state)
- Mock data must have ZERO presence in production code paths
- Clear separation: dev tooling ≠ production architecture

---

## New API Endpoints

```
GET /api/stocks                       # Top 10 stock assets
GET /api/stocks/:symbol               # Single stock details
GET /api/stocks/search?q=             # Search stocks by name/symbol
GET /api/stocks/batch?symbols=        # Multiple stocks (max 20)
GET /api/stocks/status                # Service health status
```

---

## New Files Created

```
server/
├── lib/
│   └── circuitBreaker.ts            # Circuit breaker implementation
├── api/stocks/
│   ├── service.ts                   # Finnhub integration (mock in dev only)
│   └── routes.ts                    # Stock API endpoints
├── mocks/
│   ├── index.ts                     # Mock data loader
│   └── finnhub/
│       ├── quotes.json              # Mock stock quotes (10 symbols)
│       └── profiles.json            # Mock company profiles

shared/
└── schema.ts                        # Added unified Asset types
```

---

## Configuration

### Environment Variables
```env
FINNHUB_API_KEY=     # Optional in dev (uses mocks)
USE_REAL_API=true    # Override mock mode in development
```

### SSRF Allowlist Updated
```typescript
// server/lib/apiClient.ts
const ALLOWED_HOSTS = [
  // ... existing
  'finnhub.io',
  'api.finnhub.io',
  'api.groq.com',      // AI fallback
  'generativelanguage.googleapis.com', // Gemini
];
```

---

## Testing

### Verified Working
- [x] TypeScript compiles without errors
- [x] `GET /api/stocks` returns mock data (dev mode)
- [x] `GET /api/stocks/AAPL` returns single stock
- [x] `GET /api/stocks/status` returns service health
- [x] Circuit breaker state tracking
- [x] Mock data used ONLY in development
- [x] Production returns null on API failure (no mock fallback)

### Pending
- [ ] Integration test with real Finnhub API
- [ ] UI components for stock display
- [ ] Unified search across crypto + stocks

---

## Session Notes (2025-12-08)

### Engineering Mindset
Followed unified doc patterns:
1. **What → Why → How** framework for decisions
2. **SOLID principles** in type design (Open/Closed)
3. **Reliability engineering** (Circuit Breaker)
4. **YAGNI** - no WebSocket until needed
5. **Mock-first development** - zero API calls in dev

### Trade-offs Accepted
- 60s price staleness (acceptable for MVP)
- No real-time updates (polling sufficient)
- Limited search (free tier constraint)
- Stale > Error for user experience

### Next Steps (Phase 2: UI Integration)
1. Add "Stocks" section to Dashboard
2. Create StockCard component (match PriceCard style)
3. Add stock search to Header
4. Create StocksPage for detailed view
5. Unified asset search

---

## Dependencies

No new dependencies added - using existing:
- Express (HTTP server)
- Zod (validation)
- Built-in Node.js fetch (API calls)
