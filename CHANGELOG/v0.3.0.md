# TickerHub Changelog - v0.3.0 (Persistence Layer)

**Release Date:** 2025-12-09 (In Progress)
**Branch:** `feature/stock-market-expansion`
**Status:** Phase 3a-3h Complete (Database + Auth + Watchlist + Tests + Client UI + Auth UI + Watchlist Page)

---

## Overview

Phase 3: The Persistence Layer - Transitioning TickerHub from a public dashboard to a personalized platform with user authentication and database-backed features.

---

## Stack Selection

| Component | Choice | Rationale |
|-----------|--------|-----------|
| **Database** | **Neon PostgreSQL 17** | Serverless Postgres. Scales to zero. Free tier with ~6h PITR. |
| **ORM** | **Drizzle** | Type-safe. Zero runtime dependency. Standard SQL migrations. |
| **Auth** | **Better Auth** | Lucia successor. Self-hosted. ESM-native. Express.js compatible. |

---

## Features Implemented

### Phase 3a: Database Setup (DONE)

**Neon PostgreSQL Configuration:**
- Provisioned Neon project (Frankfurt region, PostgreSQL 17)
- Dual connection strategy implemented:
  - **Pooled** (`DATABASE_URL`): For app runtime via pgbouncer
  - **Unpooled** (`DATABASE_URL_UNPOOLED`): For migrations (direct connection)

**Reasoning:**
Neon's connection pooler (pgbouncer) doesn't handle schema changes well. Migrations need direct connections to execute DDL statements reliably. The app uses pooled connections for better concurrency handling.

**Files Modified:**
- `.env` - Added `DATABASE_URL` and `DATABASE_URL_UNPOOLED`

---

### Phase 3b: Drizzle + Neon Connection (DONE)

**Dependencies Installed:**
```bash
npm install @neondatabase/serverless ws
```

**Database Client Implementation:**
- WebSocket-based connection pool for Node.js environment
- Schema-aware Drizzle instance with full type inference
- Location: `server/db/index.ts`

**Key Implementation Details:**
```typescript
// Configure WebSocket for Node.js (required for @neondatabase/serverless)
neonConfig.webSocketConstructor = ws;

// Use pooled connection for app runtime
const pool = new Pool({ connectionString: process.env.DATABASE_URL });
export const db = drizzleWs(pool, { schema: allSchemas });
```

**Reasoning:**
- `@neondatabase/serverless` with WebSocket is for Node.js environments
- HTTP driver is only for edge/serverless functions (Vercel Edge, Cloudflare Workers)
- WebSocket provides persistent connections, better for Express app

**Migration Configuration:**
- Updated `drizzle.config.ts` to prefer `DATABASE_URL_UNPOOLED`
- Multi-schema support: `["./shared/schema.ts", "./shared/auth-schema.ts"]`

**Initial Migration:**
```sql
-- migrations/0000_curious_siren.sql
CREATE TABLE "users" (
  "id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "username" text NOT NULL,
  "password" text NOT NULL,
  CONSTRAINT "users_username_unique" UNIQUE("username")
);
```

**Files Created:**
- `server/db/index.ts` - Drizzle client with Neon WebSocket pool

**Files Modified:**
- `drizzle.config.ts` - Multi-schema, unpooled connection for migrations

---

### Phase 3c: Better Auth Integration (DONE)

**Dependencies Installed:**
```bash
npm install better-auth
```

**Auth Schema Generated:**
Used `@better-auth/cli generate` to create auth tables:
- `user` - Core user data (email, name, emailVerified, image)
- `session` - Session tokens with expiry
- `account` - OAuth providers and credentials
- `verification` - Email/password verification tokens

**Schema Location:** `shared/auth-schema.ts`

**Auth Configuration:**
- Drizzle adapter with PostgreSQL provider
- Email/password authentication enabled
- 7-day session expiry with 24-hour refresh
- Cookie-based session caching (5 minutes)
- Location: `server/auth/index.ts`

**CRITICAL Integration Pattern:**
```typescript
// server/index.ts - ORDER MATTERS!
// Better Auth handler MUST come BEFORE express.json()

app.all('/api/auth/*', toNodeHandler(auth));  // Auth handler FIRST
app.use(express.json());                       // Body parser AFTER
```

**Reasoning:**
Better Auth needs to parse the request body itself. If `express.json()` runs first, it consumes the body stream, and the auth handler receives an empty body, causing API hangs.

**Auth Migration:**
```sql
-- migrations/0001_nice_tempest.sql
CREATE TABLE "user" (...);
CREATE TABLE "session" (...);
CREATE TABLE "account" (...);
CREATE TABLE "verification" (...);
CREATE INDEX "session_userId_idx" ON "session" ("user_id");
CREATE INDEX "account_userId_idx" ON "account" ("user_id");
CREATE INDEX "verification_identifier_idx" ON "verification" ("identifier");
```

**Files Created:**
- `server/auth/index.ts` - Better Auth configuration
- `shared/auth-schema.ts` - Auth table definitions (generated)
- `migrations/0001_nice_tempest.sql` - Auth tables migration

**Files Modified:**
- `server/index.ts` - Mounted auth handler before body parser
- `server/db/index.ts` - Merged auth schema into Drizzle instance

---

## API Endpoints Added

### Auth Endpoints (Public)
```
GET  /api/auth/ok                    # Health check (returns {"ok":true})
POST /api/auth/sign-up/email         # Create account with email/password
POST /api/auth/sign-in/email         # Sign in with email/password
POST /api/auth/sign-out              # End session
GET  /api/auth/get-session           # Get current session
```

### Watchlist Endpoints (Protected - Requires Auth)
```
GET    /api/watchlist                # Get user's watchlist
POST   /api/watchlist                # Add asset {"assetId":"bitcoin","assetType":"crypto"}
DELETE /api/watchlist/:assetId       # Remove asset from watchlist
GET    /api/watchlist/check/:assetId # Check if asset in watchlist
```

---

## Architecture Decisions

### ADR-011: Dual Connection Strategy for Neon
**Decision:** Maintain two connection strings (pooled + unpooled)
**Rationale:**
- Neon's pgbouncer pooler doesn't handle DDL (CREATE TABLE, ALTER, etc.)
- Migrations require direct database connection
- App runtime benefits from connection pooling for concurrent requests
- Industry standard pattern for managed Postgres with poolers

### ADR-012: Better Auth over Lucia
**Decision:** Use Better Auth instead of Lucia for authentication
**Rationale:**
- Lucia deprecated as of 2024 (see github.com/lucia-auth/lucia/discussions/1707)
- Better Auth is the recommended successor
- Native ESM support (matches our build)
- Works with Drizzle ORM out of the box
- Self-hosted (no vendor lock-in)

### ADR-013: Auth Handler Before Body Parser
**Decision:** Mount Better Auth handler before `express.json()` middleware
**Rationale:**
- Better Auth reads raw request body for CSRF protection
- Express body parsers consume the stream, leaving nothing for auth
- This is a documented requirement in Better Auth Express.js guide
- Pattern applies to any auth library that needs raw body access

### ADR-014: WebSocket Driver for Node.js
**Decision:** Use `@neondatabase/serverless` with WebSocket, not HTTP
**Rationale:**
- HTTP driver is optimized for edge functions (Vercel Edge, Cloudflare Workers)
- Node.js Express app benefits from persistent WebSocket connections
- WebSocket driver handles connection pooling natively
- Matches Neon's official recommendation for Node.js environments

---

## Testing Verification

### Endpoints Tested
```bash
# Health check
$ curl http://localhost:5000/api/auth/ok
{"ok":true}

# User signup (verified creates user in Neon database)
$ curl -X POST http://localhost:5000/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@tickerhub.dev","password":"testpassword123","name":"Test User"}'
{"token":"Z98sEAkSTMpmEJmbzKUifQatTAkLCe3l","user":{"name":"Test User","email":"test@tickerhub.dev",...}}
```

### Database Verified
- `npx drizzle-kit studio` connects successfully
- All 5 tables created: `users`, `user`, `session`, `account`, `verification`
- User record persisted after signup test

---

## New Files Created

```
server/
├── db/
│   └── index.ts              # Drizzle client with Neon WebSocket pool
├── auth/
│   └── index.ts              # Better Auth configuration
├── middleware/
│   └── requireAuth.ts        # Auth middleware (requireAuth, optionalAuth)
├── api/
│   └── watchlist/
│       └── routes.ts         # Watchlist CRUD endpoints

shared/
└── auth-schema.ts            # Better Auth + Watchlist table definitions

migrations/
├── 0000_curious_siren.sql    # Initial users table
├── 0001_nice_tempest.sql     # Better Auth tables
└── 0002_ordinary_chimera.sql # Watchlist table
```

---

## Configuration Changes

### Environment Variables Added
```env
# Pooled connection - for Express app runtime
DATABASE_URL=postgresql://...@...-pooler.../neondb?sslmode=require

# Direct connection - for Drizzle Kit migrations
DATABASE_URL_UNPOOLED=postgresql://...@.../neondb?sslmode=require
```

### drizzle.config.ts Updated
```typescript
export default defineConfig({
  schema: ["./shared/schema.ts", "./shared/auth-schema.ts"],
  dbCredentials: {
    url: process.env.DATABASE_URL_UNPOOLED || process.env.DATABASE_URL,
  },
});
```

---

## Dependencies Added

| Package | Version | Purpose |
|---------|---------|---------|
| `@neondatabase/serverless` | ^1.0.0 | Neon PostgreSQL driver |
| `ws` | ^8.0.0 | WebSocket for Node.js |
| `better-auth` | ^1.4.0 | Authentication library |

---

## Session Notes (2025-12-09)

### Research-First Approach
Before implementation, researched:
1. Better Auth Express.js integration (official docs)
2. Drizzle + Neon connection pooling best practices
3. Neon driver selection (WebSocket vs HTTP)
4. Body parser ordering with auth handlers

### Critical Discovery
The `express.json() BEFORE auth handler` bug is a common pitfall. Better Auth docs mention it, but it's easy to miss. The symptom is API requests hanging indefinitely with no error.

---

### Phase 3d: Protected Routes & Watchlist (DONE)

**Auth Middleware Created:**
- `requireAuth` - Returns 401 if not authenticated, attaches `req.user` and `req.session`
- `optionalAuth` - Attaches user if present, doesn't require auth
- Location: `server/middleware/requireAuth.ts`

**Watchlist Schema:**
```typescript
export const watchlist = pgTable("watchlist", {
  id: serial("id").primaryKey(),
  userId: text("user_id").references(() => user.id, { onDelete: "cascade" }),
  assetId: text("asset_id").notNull(),     // "bitcoin", "AAPL"
  assetType: text("asset_type").notNull(), // "crypto" | "stock"
  addedAt: timestamp("added_at").defaultNow(),
}, (table) => [
  index("watchlist_userId_idx").on(table.userId),
  uniqueIndex("watchlist_userId_assetId_idx").on(table.userId, table.assetId),
]);
```

**Watchlist Migration:**
```sql
-- migrations/0002_ordinary_chimera.sql
CREATE TABLE "watchlist" (...);
CREATE INDEX "watchlist_userId_idx" ON "watchlist" ("user_id");
CREATE UNIQUE INDEX "watchlist_userId_assetId_idx" ON "watchlist" ("user_id", "asset_id");
```

**Watchlist API Endpoints:**
```
GET    /api/watchlist              # Get user's watchlist (requires auth)
POST   /api/watchlist              # Add asset to watchlist (requires auth)
DELETE /api/watchlist/:assetId     # Remove asset from watchlist (requires auth)
GET    /api/watchlist/check/:assetId # Check if asset in watchlist (requires auth)
```

**Tested & Verified:**
```bash
# Without auth - 401
$ curl http://localhost:5000/api/watchlist
{"error":"Unauthorized","message":"Authentication required"}

# With session cookie - Success
$ curl -c cookies.txt -X POST .../api/auth/sign-in/email ...
$ curl -b cookies.txt http://localhost:5000/api/watchlist
{"items":[],"count":0}

# Add asset
$ curl -b cookies.txt -X POST .../api/watchlist -d '{"assetId":"bitcoin","assetType":"crypto"}'
{"message":"Asset added to watchlist","item":{"id":1,"assetId":"bitcoin",...}}

# Duplicate prevention - 409
$ curl -b cookies.txt -X POST .../api/watchlist -d '{"assetId":"bitcoin","assetType":"crypto"}'
{"error":"Conflict","message":"Asset already in watchlist"}

# Delete asset
$ curl -b cookies.txt -X DELETE .../api/watchlist/bitcoin
{"message":"Asset removed from watchlist","assetId":"bitcoin"}
```

**Files Created:**
- `server/middleware/requireAuth.ts` - Auth middleware (requireAuth, optionalAuth)
- `server/api/watchlist/routes.ts` - Watchlist CRUD endpoints
- `migrations/0002_ordinary_chimera.sql` - Watchlist table migration

**Files Modified:**
- `shared/auth-schema.ts` - Added watchlist table definition
- `server/api/index.ts` - Mounted watchlist routes

---

### Phase 3e: Integration Tests for Auth + Watchlist (DONE)

**Test Infrastructure Updates:**
- Updated `vitest.setup.ts` to load environment variables via `dotenv/config`
- Added Neon database bypass to MSW (allows database connections during tests)

**Auth App Factory for Testing:**
Created `tests/integration/helpers/authApp.ts`:
- `createTestAppWithAuth()` - Express app with Better Auth handler before `express.json()`
- `generateTestUser()` - Generates unique test user credentials per test run
- `signUpAndGetCookies()` - Helper to sign up and retrieve session cookies
- `signInAndGetCookies()` - Helper to sign in and retrieve session cookies

**Auth Integration Tests (15 tests):**
Located in `tests/integration/api/auth.test.ts`:

| Test | Description |
|------|-------------|
| `GET /api/auth/ok` | Health check returns `{ ok: true }` |
| `POST /api/auth/sign-up/email` | Valid signup creates user and returns session cookie |
| `POST /api/auth/sign-up/email` | Duplicate email returns 422 |
| `POST /api/auth/sign-up/email` | Missing email returns 400 |
| `POST /api/auth/sign-up/email` | Missing password returns error (400/500) |
| `POST /api/auth/sign-up/email` | Weak password returns 400 |
| `POST /api/auth/sign-in/email` | Valid credentials return session |
| `POST /api/auth/sign-in/email` | Wrong password returns 401 |
| `POST /api/auth/sign-in/email` | Non-existent user returns 401 |
| `GET /api/auth/get-session` | Returns null without auth |
| `GET /api/auth/get-session` | Returns session with valid cookie |
| `POST /api/auth/sign-out` | Sign out succeeds with session |
| `POST /api/auth/sign-out` | Sign out handles missing session gracefully |
| Database Integration | User record persisted on signup |
| Database Integration | Session record persisted on signin |

**Watchlist Integration Tests (20 tests):**
Located in `tests/integration/api/watchlist.test.ts`:

| Test | Description |
|------|-------------|
| Authentication Required (4) | All endpoints return 401 without auth |
| `GET /api/watchlist` | Empty list for new user |
| `GET /api/watchlist` | Returns items after adding assets |
| `POST /api/watchlist` | Add crypto asset succeeds (201) |
| `POST /api/watchlist` | Add stock asset succeeds (201) |
| `POST /api/watchlist` | Duplicate returns 409 Conflict |
| `POST /api/watchlist` | Missing assetId returns 400 |
| `POST /api/watchlist` | Missing assetType returns 400 |
| `POST /api/watchlist` | Invalid assetType returns 400 |
| `POST /api/watchlist` | Empty assetId returns 400 |
| `DELETE /api/watchlist/:assetId` | Remove asset succeeds |
| `DELETE /api/watchlist/:assetId` | Non-existent returns 404 |
| `GET /api/watchlist/check/:assetId` | Returns false for missing |
| `GET /api/watchlist/check/:assetId` | Returns true for existing |
| Database Integration | Item persisted to database |
| Database Integration | Cascade delete on user removal |
| User Isolation | Users can't see each other's watchlists |

**Key Testing Patterns:**

1. **Auth App vs Regular Test App:**
   - Auth tests require `toNodeHandler(auth)` mounted BEFORE `express.json()`
   - Created separate `createTestAppWithAuth()` for auth-enabled tests

2. **Database Bypass in MSW:**
   ```typescript
   // Allow Neon PostgreSQL connections
   if (url.hostname.includes('neon.tech')) {
     return; // Bypass
   }
   ```

3. **Test Isolation:**
   - Each test uses `generateTestUser()` with unique timestamp-based email
   - Cleanup via `afterAll` deleting `*@tickerhub.test` users

4. **Cookie-Based Auth Testing:**
   ```typescript
   const cookies = signupResponse.headers['set-cookie'];
   await request(app)
     .get('/api/watchlist')
     .set('Cookie', cookies)
     .expect(200);
   ```

**Test Results:**
```
Test Files  2 passed (2)
Tests       35 passed (35)
Duration    7.86s
```

**Files Created:**
- `tests/integration/helpers/authApp.ts` - Auth-enabled test app factory
- `tests/integration/api/auth.test.ts` - Auth endpoint tests (15 tests)
- `tests/integration/api/watchlist.test.ts` - Watchlist endpoint tests (20 tests)

**Files Modified:**
- `tests/setup/vitest.setup.ts` - Added dotenv, Neon bypass

---

### Phase 3f: Client-Side Auth & Watchlist UI (DONE)

**Better Auth React Client:**
Created `client/src/lib/auth-client.ts`:
```typescript
import { createAuthClient } from 'better-auth/react';

const authClient = createAuthClient({
  // baseURL optional when on same origin
});

export const { signIn, signUp, signOut, useSession, getSession } = authClient;
```

**Auth Hook (`useAuth`):**
Created `client/src/hooks/useAuth.ts`:
- `user` - Current user object or null
- `isAuthenticated` - Boolean auth state
- `isLoading` - Session loading state
- `error` - Error object if any
- `login(email, password)` - Sign in with credentials
- `register(email, password, name)` - Create new account
- `logout()` - End session
- `refetch()` - Refresh session state

**Watchlist Hooks:**
Created `client/src/hooks/useWatchlist.ts`:

| Hook | Purpose |
|------|---------|
| `useWatchlist()` | Fetch user's full watchlist |
| `useWatchlistCheck(assetId)` | Check if specific asset in watchlist |
| `useWatchlistMutations()` | Add/remove mutations with cache updates |
| `useAssetWatchlist(assetId, assetType)` | Combined hook for single asset |

**Query Key Structure:**
```typescript
export const watchlistKeys = {
  all: ['watchlist'],
  list: () => [...watchlistKeys.all, 'list'],
  check: (assetId) => [...watchlistKeys.all, 'check', assetId],
};
```

**WatchlistButton Component:**
Created `client/src/components/WatchlistButton.tsx`:
- Star icon (filled when in watchlist, outline when not)
- Tooltip shows action
- Disabled state for unauthenticated users
- Loading animation while toggling
- `onClick` stops propagation (safe to use inside clickable cards)

**Integration with Asset Cards:**
- `PriceCard.tsx` - Added WatchlistButton for crypto assets
- `StockCard.tsx` - Added WatchlistButton for stock assets

**Files Created:**
- `client/src/lib/auth-client.ts` - Better Auth React client
- `client/src/hooks/useAuth.ts` - Auth state and actions hook
- `client/src/hooks/useWatchlist.ts` - Watchlist hooks (4 hooks)
- `client/src/components/WatchlistButton.tsx` - Toggle button component

**Files Modified:**
- `client/src/components/PriceCard.tsx` - Added WatchlistButton
- `client/src/components/StockCard.tsx` - Added WatchlistButton

---

### Phase 3g: Auth UI Components (DONE)

**Research-Driven Decision:**
- Explored Better Auth UI library (pre-built shadcn components)
- Decided simpler approach: leverage existing shadcn/ui components
- No new dependencies needed - uses Dialog, DropdownMenu, Form already in codebase

**AuthDialog Component:**
Created `client/src/components/auth/AuthDialog.tsx`:
- Tabbed login/register forms in single Dialog
- Zod validation schemas (email, password min 8 chars, confirm password match)
- react-hook-form integration for validation
- Loading states with spinner
- Error display for failed auth attempts
- Styled with existing theme (bg-card/95 backdrop-blur-md)

**UserMenu Component:**
Created `client/src/components/auth/UserMenu.tsx`:
- **Unauthenticated:** Shows "Sign in" and "Get Started" buttons
- **Authenticated:** Avatar dropdown with:
  - User name and email display
  - Watchlist link
  - Settings link
  - Sign out action
- Avatar initials from name (e.g., "John Doe" → "JD")
- Loading skeleton while auth state resolves

**Header Integration:**
Modified `client/src/components/layout/Header.tsx`:
- Added UserMenu to right side of header (next to Live indicator)
- Import from new `@/components/auth` barrel export

**Files Created:**
- `client/src/components/auth/AuthDialog.tsx` - Login/register dialog with forms
- `client/src/components/auth/UserMenu.tsx` - User avatar dropdown / sign-in buttons
- `client/src/components/auth/index.ts` - Barrel export

**Files Modified:**
- `client/src/components/layout/Header.tsx` - Added UserMenu import and component

**Build Verified:**
- TypeScript compiles without errors
- Vite builds successfully (930KB JS bundle)

---

### Phase 3h: Watchlist Page & Batch APIs (DONE)

**Backend: Batch API Endpoints**

Stocks batch already existed: `GET /api/stocks/batch?symbols=AAPL,MSFT`

Added crypto batch endpoint:
- `GET /api/prices/batch?ids=bitcoin,ethereum,solana`
- CoinGecko `ids` parameter for efficient single-request fetching
- Max 50 coins per request
- Same caching strategy as `/api/prices`

**Service Layer:**
- Added `fetchPricesByIds(ids: string[])` to `server/api/crypto/service.ts`
- Uses CoinGecko `/coins/markets?ids=` endpoint

**Client Hooks:**
- Added `useCryptoBatch(ids: string[])` to `client/src/features/crypto/hooks/usePrices.ts`
- Added `PRICES_BATCH` to `client/src/lib/constants.ts`

**Watchlist Page (`/watchlist`):**
Created `client/src/pages/WatchlistPage.tsx`:
- **Not authenticated:** Shows sign-in prompt with AuthDialog
- **Empty watchlist:** Shows empty state with links to Dashboard/Markets
- **With items:** Separates crypto and stock sections
- Uses batch APIs for efficient price fetching (one request per asset type)
- Reuses existing `PriceCard` and `StockCard` components
- Real-time updates via `refetchInterval`
- Loading skeletons while fetching prices

**UX Features:**
- Star icon in header (yellow filled)
- Section headers showing count: "Cryptocurrencies (3)"
- Remove from watchlist via existing WatchlistButton on cards
- Skeleton loading states per section

**Files Created:**
- `client/src/pages/WatchlistPage.tsx` - Watchlist page component

**Files Modified:**
- `server/api/crypto/service.ts` - Added `fetchPricesByIds()`
- `server/api/crypto/routes.ts` - Added `/api/prices/batch` endpoint
- `client/src/lib/constants.ts` - Added `PRICES_BATCH` endpoint
- `client/src/features/crypto/hooks/usePrices.ts` - Added `useCryptoBatch()`
- `client/src/features/crypto/hooks/index.ts` - Exported `useCryptoBatch`
- `client/src/App.tsx` - Added `/watchlist` route

---

### Next Steps (Phase 3i)
1. Consider Settings page for user preferences
2. Add price alerts/notifications (future enhancement)

---

## Migration Commands Reference

```bash
# Generate migration from schema changes
npx drizzle-kit generate

# Apply migrations to database
npx drizzle-kit migrate

# Launch Drizzle Studio (database GUI)
npx drizzle-kit studio
```

---

## Sources & References

- [Better Auth Docs](https://www.better-auth.com/docs)
- [Better Auth Express.js Guide](https://www.better-auth.com/docs/integrations/express)
- [Drizzle + Neon Guide](https://orm.drizzle.team/docs/connect-neon)
- [Neon Connection Pooling](https://neon.tech/docs/connect/connection-pooling)
- [Lucia Deprecation Notice](https://github.com/lucia-auth/lucia/discussions/1707)
